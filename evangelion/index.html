<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evangelion - Japanese Listening Practice</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        h1 { text-align: center; color: #4a4a4a; margin-bottom: 8px; }

        .chapter-select {
            text-align: center;
            margin-bottom: 24px;
        }
        .chapter-select select {
            padding: 10px 16px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
            color: #333;
            cursor: pointer;
            min-width: 250px;
        }

        .progress-info {
            text-align: center;
            color: #666;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .time {
            color: #888;
            font-size: 13px;
            margin-bottom: 16px;
        }
        .japanese {
            font-size: 28px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #222;
        }
        audio {
            width: 100%;
            margin-bottom: 20px;
        }

        .translation {
            font-size: 20px;
            color: #1a5276;
            padding: 16px;
            background: #e8f4f8;
            border-radius: 8px;
            line-height: 1.5;
            display: none;
        }
        .translation.revealed {
            display: block;
        }

        .reveal-hint {
            text-align: center;
            color: #888;
            font-size: 13px;
            margin-top: 12px;
        }
        .reveal-hint.hidden {
            display: none;
        }

        .vocab-section {
            margin-top: 20px;
            display: none;
        }
        .vocab-section.revealed {
            display: block;
        }
        .vocab-section h3 {
            color: #4a4a4a;
            margin: 0 0 12px 0;
            font-size: 14px;
            text-transform: uppercase;
        }
        .vocab-item {
            display: flex;
            gap: 16px;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
            align-items: baseline;
        }
        .vocab-item:last-child { border-bottom: none; }
        .vocab-word { font-weight: bold; color: #222; min-width: 100px; font-size: 20px; }
        .vocab-reading { color: #666; min-width: 100px; font-size: 18px; }
        .vocab-meaning { color: #444; font-size: 17px; }

        .grammar {
            font-size: 16px;
            color: #856404;
            padding: 14px;
            background: #fff3cd;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.5;
            display: none;
        }
        .grammar.revealed {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }
        .nav-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            background: #e0e0e0;
            color: #333;
        }
        .nav-btn:hover:not(:disabled) {
            background: #d0d0d0;
            transform: translateY(-2px);
        }
        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .nav-btn.primary {
            background: #5d6d7e;
            color: #fff;
        }
        .nav-btn.primary:hover:not(:disabled) {
            background: #4a5a6a;
        }

        .keyboard-hints {
            text-align: center;
            margin-top: 20px;
            color: #888;
            font-size: 12px;
        }
        .keyboard-hints kbd {
            background: #e0e0e0;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: inherit;
        }

        .settings-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .settings-bar label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #5d6d7e;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Mobile replay button */
        .replay-btn {
            display: none;
            width: 100%;
            padding: 16px;
            margin-bottom: 20px;
            background: #5d6d7e;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .replay-btn:active {
            background: #4a5a6a;
        }

        /* Mobile swipe hints */
        .swipe-hints {
            display: none;
            text-align: center;
            margin-top: 20px;
            color: #888;
            font-size: 13px;
        }

        /* Progress slider */
        .progress-slider-container {
            display: none;
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .progress-slider-container.visible {
            display: block;
        }
        .progress-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }
        .progress-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #5d6d7e;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .progress-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #5d6d7e;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* Make thumb larger on mobile for easier touch */
        @media (max-width: 768px) {
            .progress-slider {
                height: 10px;
            }
            .progress-slider::-webkit-slider-thumb {
                width: 32px;
                height: 32px;
            }
            .progress-slider::-moz-range-thumb {
                width: 32px;
                height: 32px;
            }
        }

        /* Counter pulse animation */
        @keyframes counterPulse {
            0% { transform: scale(1); color: #666; }
            50% { transform: scale(1.15); color: #5d6d7e; }
            100% { transform: scale(1); color: #666; }
        }
        .progress-info.pulse {
            animation: counterPulse 0.3s ease-out;
        }
        @media (max-width: 768px) {
            .progress-info.pulse {
                color: #333;
            }
        }

        /* Card change highlight animation */
        @keyframes cardHighlight {
            0% { box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 0 0 3px rgba(93, 109, 126, 0.5); }
            100% { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        }
        .card.highlight {
            animation: cardHighlight 0.4s ease-out;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .progress-info {
                font-size: 20px;
                font-weight: 600;
                color: #333;
            }
            .replay-btn {
                display: block;
            }
            .keyboard-hints {
                display: none !important;
            }
            .swipe-hints {
                display: block;
            }
        }
    </style>
</head>
<body>
    <h1>Evangelion</h1>

    <div class="chapter-select">
        <select id="chapterSelect" onchange="loadChapter(this.value)">
            <option value="">-- Select Episode --</option>
            <option value="episode_01">Episode 01「使徒、襲来」</option>
            <option value="episode_02">Episode 02「見知らぬ、天井」</option>
            <option value="episode_03">Episode 03「鳴らない、電話」</option>
            <option value="episode_04">Episode 04「雨、逃げ出した後」</option>
            <option value="episode_05">Episode 05「レイ、心のむこうに」</option>
            <option value="episode_06">Episode 06「決戦、第3新東京市」</option>
            <option value="episode_07">Episode 07「人の造りしもの」</option>
            <option value="episode_08">Episode 08「アスカ、来日」</option>
            <option value="episode_09">Episode 09「瞬間、心、重ねて」</option>
            <option value="episode_10">Episode 10「マグマダイバー」</option>
            <option value="episode_11">Episode 11「静止した闇の中で」</option>
            <option value="episode_12">Episode 12「奇跡の価値は」</option>
            <option value="episode_13">Episode 13「使徒、侵入」</option>
            <option value="episode_14">Episode 14「ゼーレ、魂の座」</option>
            <option value="episode_15">Episode 15「嘘と沈黙」</option>
            <option value="episode_16">Episode 16「死に至る病、そして」</option>
            <option value="episode_17">Episode 17「四人目の適格者」</option>
            <option value="episode_18">Episode 18「命の選択を」</option>
        </select>
    </div>

    <div class="settings-bar">
        <label>
            <span>Show translation by default</span>
            <div class="toggle-switch">
                <input type="checkbox" id="showByDefault" onchange="saveShowByDefault()">
                <span class="toggle-slider"></span>
            </div>
        </label>
    </div>

    <div class="progress-info" id="progressInfo">Select a chapter to begin</div>

    <div class="progress-slider-container" id="sliderContainer">
        <input type="range" class="progress-slider" id="progressSlider" min="1" max="100" value="1">
    </div>

    <div id="cardContainer"></div>

    <div class="nav-buttons" id="navButtons" style="display: none;">
        <button class="nav-btn" id="prevBtn" onclick="goToPrevious()">← Previous</button>
        <button class="nav-btn primary" id="nextBtn" onclick="goToNext()">Next →</button>
    </div>

    <div class="keyboard-hints" id="keyboardHints" style="display: none;">
        <kbd>←</kbd> Previous &nbsp;&nbsp; <kbd>Space</kbd> Reveal/Hide &nbsp;&nbsp; <kbd>→</kbd> Next
    </div>

    <div class="swipe-hints" id="swipeHints" style="display: none;">
        Tap edges or swipe: ← Prev &nbsp;|&nbsp; ↓ Reveal ↑ Hide &nbsp;|&nbsp; Next →
    </div>

    <script>
        let data = [];
        let currentIndex = 0;
        let revealed = false;
        let currentChapter = '';
        let showByDefault = localStorage.getItem('eva_show_by_default') === 'true';

        // Initialize toggle on page load
        document.getElementById('showByDefault').checked = showByDefault;

        function saveShowByDefault() {
            showByDefault = document.getElementById('showByDefault').checked;
            localStorage.setItem('eva_show_by_default', showByDefault);

            // Also update the current card immediately
            const translation = document.getElementById('translation');
            const revealHint = document.getElementById('revealHint');
            const vocabSection = document.getElementById('vocabSection');
            const grammarSection = document.getElementById('grammarSection');

            if (translation) {
                revealed = showByDefault;
                translation.classList.toggle('revealed', showByDefault);
                if (revealHint) revealHint.classList.toggle('hidden', showByDefault);
                if (vocabSection) vocabSection.classList.toggle('revealed', showByDefault);
                if (grammarSection) grammarSection.classList.toggle('revealed', showByDefault);
            }
        }

        async function loadChapter(chapter) {
            if (!chapter) return;

            currentChapter = chapter;
            currentIndex = 0;
            revealed = false;

            try {
                const response = await fetch(`${chapter}/data.json`);
                if (!response.ok) {
                    // Try segments.json if data.json doesn't exist
                    const segResponse = await fetch(`${chapter}/segments.json`);
                    if (!segResponse.ok) throw new Error('No data found');
                    data = await segResponse.json();
                } else {
                    data = await response.json();
                }

                // Restore position
                const saved = localStorage.getItem(`eva_position_${chapter}`);
                if (saved) {
                    currentIndex = Math.min(parseInt(saved), data.length - 1);
                }

                document.getElementById('navButtons').style.display = 'flex';
                document.getElementById('keyboardHints').style.display = 'block';
                document.getElementById('swipeHints').style.display = 'block';

                // Setup slider
                const slider = document.getElementById('progressSlider');
                slider.max = data.length;
                slider.value = currentIndex + 1;
                document.getElementById('sliderContainer').classList.add('visible');

                showCard();
            } catch (e) {
                document.getElementById('cardContainer').innerHTML =
                    '<div class="card"><p>Episode not yet processed. Run build_evangelion.py first.</p></div>';
                document.getElementById('progressInfo').textContent = 'Error loading chapter';
            }
        }

        function showCard() {
            if (data.length === 0) return;

            const card = data[currentIndex];
            revealed = false;

            localStorage.setItem(`eva_position_${currentChapter}`, currentIndex);

            const progressEl = document.getElementById('progressInfo');
            progressEl.textContent = `Card ${currentIndex + 1} of ${data.length}`;

            // Trigger counter pulse animation
            progressEl.classList.remove('pulse');
            void progressEl.offsetWidth; // Force reflow to restart animation
            progressEl.classList.add('pulse');

            let vocabHtml = '';
            if (card.vocabulary && card.vocabulary.length > 0) {
                vocabHtml = `
                    <div class="vocab-section" id="vocabSection">
                        <h3>Vocabulary</h3>
                        ${card.vocabulary.map(v => `
                            <div class="vocab-item">
                                <span class="vocab-word">${v.word}</span>
                                <span class="vocab-reading">${v.reading}</span>
                                <span class="vocab-meaning">${v.meaning}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            let grammarHtml = '';
            if (card.grammar) {
                grammarHtml = `<div class="grammar" id="grammarSection">${card.grammar}</div>`;
            }

            const translationText = card.translation || '(Translation not yet generated)';

            document.getElementById('cardContainer').innerHTML = `
                <div class="card">
                    <div class="time">${card.start} - ${card.end}</div>
                    <div class="japanese">${card.text.replace(/ \/ /g, '<br>')}</div>
                    <audio id="cardAudio" controls src="${currentChapter}/clips/${card.audio_file}"></audio>
                    <button class="replay-btn" onclick="replayAudio()">Replay Audio</button>

                    <div class="translation" id="translation">${translationText}</div>
                    ${vocabHtml}
                    ${grammarHtml}

                    <div class="reveal-hint" id="revealHint">Press <kbd>Space</kbd> to reveal translation</div>
                </div>
            `;

            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === data.length - 1;

            // Update slider position
            document.getElementById('progressSlider').value = currentIndex + 1;

            // Apply show by default setting
            if (showByDefault) {
                revealed = true;
                document.getElementById('translation').classList.add('revealed');
                document.getElementById('revealHint').classList.add('hidden');
                const vocabSection = document.getElementById('vocabSection');
                const grammarSection = document.getElementById('grammarSection');
                if (vocabSection) vocabSection.classList.add('revealed');
                if (grammarSection) grammarSection.classList.add('revealed');
            }

            // Add highlight animation
            const cardEl = document.querySelector('.card');
            if (cardEl) {
                cardEl.classList.add('highlight');
            }

            setTimeout(() => {
                document.getElementById('cardAudio').play().catch(() => {});
            }, 200);
        }

        function toggleReveal() {
            revealed = !revealed;
            document.getElementById('translation').classList.toggle('revealed', revealed);
            document.getElementById('revealHint').classList.toggle('hidden', revealed);

            const vocabSection = document.getElementById('vocabSection');
            const grammarSection = document.getElementById('grammarSection');
            if (vocabSection) vocabSection.classList.toggle('revealed', revealed);
            if (grammarSection) grammarSection.classList.toggle('revealed', revealed);
        }

        function goToPrevious() {
            if (currentIndex > 0) {
                currentIndex--;
                showCard();
            }
        }

        function goToNext() {
            if (currentIndex < data.length - 1) {
                currentIndex++;
                showCard();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                goToPrevious();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                goToNext();
            } else if (e.key === ' ') {
                e.preventDefault();
                toggleReveal();
            }
        });

        // Slider event handler
        document.getElementById('progressSlider').addEventListener('input', (e) => {
            const newIndex = parseInt(e.target.value) - 1;
            if (newIndex !== currentIndex && newIndex >= 0 && newIndex < data.length) {
                currentIndex = newIndex;
                showCard();
            }
        });

        // Replay audio function for mobile button
        function replayAudio() {
            const audio = document.getElementById('cardAudio');
            if (audio) {
                // If audio is in an error state, reload it first
                if (audio.error || audio.networkState === 3) {
                    audio.load();
                }
                audio.currentTime = 0;
                audio.play().catch(() => {
                    // If play fails, try reloading and playing again
                    audio.load();
                    audio.oncanplay = () => {
                        audio.play().catch(() => {});
                        audio.oncanplay = null;
                    };
                });
            }
        }

        // Touch/swipe handling for mobile
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const minSwipeDistance = 80;
        const tapZoneWidth = 0.18; // 18% of screen width on each side
        const maxTapDuration = 300; // ms - taps must be quick
        const maxTapMovement = 15; // pixels - taps shouldn't move much

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            touchStartTime = Date.now();
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;

            const duration = Date.now() - touchStartTime;
            const deltaX = Math.abs(touchEndX - touchStartX);
            const deltaY = Math.abs(touchEndY - touchStartY);

            // Check if this is a tap (quick, minimal movement)
            if (duration < maxTapDuration && deltaX < maxTapMovement && deltaY < maxTapMovement) {
                handleTapZone(e);
            } else {
                handleSwipe();
            }
        }, { passive: true });

        function handleTapZone(e) {
            const target = e.target;

            // Don't intercept taps on interactive elements
            if (target.tagName === 'BUTTON' ||
                target.tagName === 'SELECT' ||
                target.tagName === 'AUDIO' ||
                target.tagName === 'INPUT' ||
                target.tagName === 'A' ||
                target.closest('button') ||
                target.closest('select') ||
                target.closest('audio') ||
                target.closest('.toggle-switch') ||
                target.closest('.progress-slider-container')) {
                return;
            }

            const screenWidth = window.innerWidth;
            const tapX = touchStartX;
            const leftZone = screenWidth * tapZoneWidth;
            const rightZone = screenWidth * (1 - tapZoneWidth);

            if (tapX < leftZone) {
                goToPrevious();
            } else if (tapX > rightZone) {
                goToNext();
            }
            // Taps in the middle do nothing (allows normal interaction)
        }

        function handleSwipe() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const absDeltaX = Math.abs(deltaX);
            const absDeltaY = Math.abs(deltaY);

            // Only trigger if swipe distance is significant
            if (Math.max(absDeltaX, absDeltaY) < minSwipeDistance) return;

            // Determine if horizontal or vertical swipe
            if (absDeltaY > absDeltaX) {
                // Vertical swipe - down to reveal, up to hide
                if (deltaY > 0 && !revealed) {
                    toggleReveal(); // Reveal
                } else if (deltaY < 0 && revealed) {
                    toggleReveal(); // Hide
                }
            } else {
                // Horizontal swipe - require it to be predominantly horizontal (2x ratio)
                if (absDeltaX < absDeltaY * 2) return;
                if (deltaX > 0) {
                    // Swipe right = previous
                    goToPrevious();
                } else {
                    // Swipe left = next
                    goToNext();
                }
            }
        }
    </script>
</body>
</html>
